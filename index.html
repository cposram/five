<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å²¡è¯äº”å­æ£‹ - å°±æ˜¯è¦ä¸Šæ¦œ</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        :root { --coffee: #6f4e37; --wood: #e3c16f; --grass: #87CEEB; --gold: #FFD700; --red: #ff4444; }
        body { margin: 0; background: var(--grass); font-family: "Microsoft JhengHei", sans-serif; overflow: hidden; display: flex; flex-direction: column; align-items: center; touch-action: none; }
        
        /* ğŸ† æ’è¡Œæ¦œï¼šæ‰å¹³åŒ–æ©«å‘æ’åˆ— (ä¸æ“‹æ£‹ç›¤) */
        #leaderboard-zone {
            position: absolute; top: 5px; left: 5px; right: 5px; 
            display: flex; flex-direction: column; gap: 4px; z-index: 110;
        }
        .row-one { display: flex; gap: 4px; }
        .row-two { width: 100%; }

        .rank-box {
            background: rgba(0,0,0,0.85); color: white; border-radius: 8px;
            padding: 4px; border: 1px solid var(--gold); box-shadow: 0 2px 8px rgba(0,0,0,0.4);
            text-align: center; flex: 1;
        }
        .rank-box b { font-size: 10px; display: block; margin-bottom: 2px; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 2px; }
        
        /* æ©«å‘åˆ—è¡¨ (ä¸Šåä¸‹æ•¸) */
        .rank-list-flex { display: flex; justify-content: space-around; gap: 2px; min-height: 25px; }
        .master-grid-list { display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px; min-height: 48px; }

        .rank-unit { 
            flex: 1; display: flex; flex-direction: column; align-items: center; 
            font-size: 9px; line-height: 1.1; border-right: 0.5px solid rgba(255,255,255,0.1);
        }
        .rank-unit:last-child { border-right: none; }
        .rank-unit .name { color: #ccc; width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .rank-unit .steps { color: var(--gold); font-weight: bold; font-size: 11px; }

        .master-grid-box { border-color: var(--red) !important; }
        .master-grid-box b { color: var(--red); }

        /* é¸å–®èˆ‡æ£‹ç›¤ */
        #setup-menu { margin-top: 170px; text-align: center; background: white; padding: 25px; border-radius: 20px; width: 85%; max-width: 300px; box-shadow: 0 8px 30px rgba(0,0,0,0.3); z-index: 100; }
        #game-container { position: relative; margin-top: 160px; z-index: 10; display: none; text-align: center; }
        canvas#victoryCanvas { position: absolute; top: 0; left: 0; pointer-events: none; z-index: 100; }
        
        #board { 
            display: grid; grid-template-columns: repeat(15, 22px); grid-template-rows: repeat(15, 22px); 
            background: var(--wood); border: 4px solid #8b4513; border-radius: 6px; cursor: pointer; margin: 0 auto;
        }
        @media (min-width: 600px) { #board { grid-template-columns: repeat(15, 38px); grid-template-rows: repeat(15, 38px); } }
        
        .cell { border: 0.5px solid rgba(139, 69, 19, 0.4); display: flex; justify-content: center; align-items: center; }
        .piece { width: 92%; height: 92%; border-radius: 50%; animation: drop 0.2s ease-out; }
        .black { background: radial-gradient(circle at 35% 35%, #444, #000); }
        .white { background: radial-gradient(circle at 35% 35%, #fff, #bbb); }
        
        .btn { background: var(--coffee); color: white; border: none; padding: 12px; margin: 8px; border-radius: 50px; font-weight: bold; cursor: pointer; font-size: 18px; box-shadow: 0 4px 0 #4e3626; width: 100%; }
        .stats { font-size: 13px; color: white; text-shadow: 1px 1px 3px #000; margin-bottom: 5px; font-weight: bold; }
    </style>
</head>
<body>

<script>
// =========================================================================
// âš™ï¸ æ ¸å¿ƒåƒæ•¸èª¿æ•´å€ (é–‹é ­è™•)
// =========================================================================
const CONFIG = {
    // æ‚¨å¯ä»¥å°‡æ­¤è™•æ”¹ç‚º 'master' (å¤§å¸«ç‰ˆ) æˆ– 'reaper' (æ­»ç¥ç‰ˆ)
    // 'master': ç¶“å…¸é˜²ç¦¦é‚è¼¯ï¼Œç©©å®šæ€§é«˜ã€‚
    // 'reaper': æ­»ç¥é‚è¼¯ï¼Œçµ•å°é˜²ç¦¦ + æ´»å£æ¬Šé‡ï¼Œæ¥µé›£åœ¨ 8 æ­¥å…§ç²å‹ã€‚
    hardVersion: 'reaper', 
    
    firebase: {
        apiKey: "AIzaSyBQr_3o913vgaWUg4PAuequLEVE1mZFS7M",
        databaseURL: "https://cowgame-48dd8-default-rtdb.firebaseio.com",
        projectId: "cowgame-48dd8"
    }
};

// --- åˆå§‹åŒ– Firebase ---
firebase.initializeApp(CONFIG.firebase);
const db = firebase.database();
const paths = { easy: 'rank_v4_easy', medium: 'rank_v4_medium', hard: 'rank_v4_hard' };
const topScores = { easy: [], medium: [], hard: [] };
</script>

<div id="leaderboard-zone">
    <div class="row-one">
        <div class="rank-box">
            <b>åˆç´š Top 3</b>
            <div id="rank-easy" class="rank-list-flex">è¼‰å…¥ä¸­...</div>
        </div>
        <div class="rank-box">
            <b>ä¸­ç´š Top 3</b>
            <div id="rank-medium" class="rank-list-flex">è¼‰å…¥ä¸­...</div>
        </div>
    </div>
    <div class="row-two">
        <div class="rank-box master-grid-box">
            <b>ğŸ”¥ å¤§å¸«æ®¿å ‚ Top 6 (ç•¶å‰å¼•æ“: <span id="engine-label"></span>)</b>
            <div id="rank-hard" class="master-grid-list">è¼‰å…¥ä¸­...</div>
        </div>
    </div>
</div>

<div id="setup-menu">
    <h1 style="color:var(--coffee); margin:0; font-size: 24px;">å²¡è¯äº”å­æ£‹</h1>
    <button class="btn" onclick="startGomoku('easy')">åˆç´š</button>
    <button class="btn" onclick="startGomoku('medium')">ä¸­ç´š</button>
    <button class="btn" onclick="startGomoku('hard')" style="background:var(--red); box-shadow:0 4px 0 #8e2020">AI å¤§å¸«å°æˆ°</button>
</div>

<div id="game-container">
    <div class="stats"><span id="display-lv"></span> | æ­¥æ•¸: <span id="step-count">0</span></div>
    <div id="board"></div>
    <canvas id="victoryCanvas"></canvas>
    <button class="btn" onclick="location.reload()" style="background:#666; box-shadow:0 4px 0 #444; margin-top:10px; width:100px; font-size:12px; padding:8px;">å›é¸å–®</button>
</div>

<script>
// --- [1] ç›£è½é‚è¼¯ ---
function listenRank(lv) {
    const limit = (lv === 'hard') ? 6 : 3;
    db.ref(paths[lv]).orderByChild('steps').limitToFirst(limit).on('value', snap => {
        const listEl = document.getElementById(`rank-${lv}`);
        topScores[lv] = [];
        let html = "";
        if (snap.exists()) {
            snap.forEach(c => {
                const d = c.val();
                topScores[lv].push(d);
                html += `<div class="rank-unit"><span class="name">${d.name}</span><span class="steps">${d.steps}æ­¥</span></div>`;
            });
            listEl.innerHTML = html;
        } else {
            listEl.innerHTML = "<span style='color:#777; font-size:9px;'>ç­‰å¾…ç´€éŒ„</span>";
        }
    });
}
['easy', 'medium', 'hard'].forEach(listenRank);
document.getElementById('engine-label').innerText = CONFIG.hardVersion.toUpperCase();

// --- [2] éŠæˆ²æ ¸å¿ƒ ---
let board = [], steps = 0, isGameOver = false, difficulty = 'easy', frameCount = 0;
const canvas = document.getElementById('victoryCanvas'), ctx = canvas.getContext('2d');
const diffLabels = { easy: 'åˆç´š', medium: 'ä¸­ç´š', hard: 'AI å¤§å¸«' };

function startGomoku(lv) {
    difficulty = lv;
    document.getElementById('setup-menu').style.display = 'none';
    document.getElementById('game-container').style.display = 'block';
    document.getElementById('display-lv').innerText = diffLabels[lv];
    initBoard();
    requestAnimationFrame(animationLoop);
}

function initBoard() {
    const el = document.getElementById('board');
    el.innerHTML = '';
    board = Array(15).fill().map(() => Array(15).fill(0));
    for (let r = 0; r < 15; r++) {
        for (let c = 0; c < 15; c++) {
            const div = document.createElement('div');
            div.className = 'cell';
            div.onclick = () => playerMove(r, c);
            el.appendChild(div);
        }
    }
    canvas.width = el.offsetWidth; canvas.height = el.offsetHeight;
}

function playerMove(r, c) {
    if (board[r][c] !== 0 || isGameOver) return;
    placePiece(r, c, 1); steps++;
    document.getElementById('step-count').innerText = steps;
    if (checkWin(r, c, 1)) { endGame(true); return; }
    setTimeout(npcMove, 450);
}

function npcMove() {
    if (isGameOver) return;
    let best = findBestMove();
    placePiece(best.r, best.c, 2);
    if (checkWin(best.r, best.c, 2)) endGame(false);
}

function placePiece(r, c, p) {
    board[r][c] = p;
    const div = document.createElement('div');
    div.className = `piece ${p === 1 ? 'black' : 'white'}`;
    document.getElementsByClassName('cell')[r * 15 + c].appendChild(div);
}

function checkWin(r, c, p) {
    const dirs = [[1,0],[0,1],[1,1],[1,-1]];
    for (let [dr, dc] of dirs) {
        let cnt = 1;
        for (let i=1; i<5; i++) if (board[r+dr*i]?.[c+dc*i] === p) cnt++; else break;
        for (let i=1; i<5; i++) if (board[r-dr*i]?.[c-dc*i] === p) cnt++; else break;
        if (cnt >= 5) return true;
    }
    return false;
}

// --- [3] åƒæ•¸åŒ– AI æ¼”ç®—æ³• ---
function findBestMove() {
    let best = {r: 7, c: 7, s: -1};
    let candidates = [];
    for(let r=0; r<15; r++) {
        for(let c=0; c<15; c++) {
            if (board[r][c] === 0) {
                let s = evalPos(r, c);
                if (s > best.s) { best = {r, c, s}; candidates = [{r, c}]; }
                else if (s === best.s) { candidates.push({r, c}); }
            }
        }
    }
    return candidates[Math.floor(Math.random() * candidates.length)];
}

function evalPos(r, c) {
    if (difficulty === 'easy') return Math.random();
    let p1 = getW(r, c, 1); // ç©å®¶å¨è„…
    let p2 = getW(r, c, 2); // è‡ªå·±å„ªå‹¢
    
    if (difficulty === 'hard') {
        let centerBonus = (7 - Math.abs(r - 7)) + (7 - Math.abs(c - 7));
        // æ ¹æ“š CONFIG åƒæ•¸æ±ºå®šé˜²ç¦¦å¼·åº¦
        let defenseMultiplier = (CONFIG.hardVersion === 'reaper') ? 2.2 : 1.8;
        return (p1 * defenseMultiplier) + p2 + centerBonus;
    }
    return p1 + p2;
}

function getW(r, c, p) {
    let w = 0;
    const dirs = [[1,0],[0,1],[1,1],[1,-1]];
    for (let [dr, dc] of dirs) {
        let cnt = 0, sides = 0;
        for (let i=1; i<5; i++) {
            if (board[r+dr*i]?.[c+dc*i] === p) cnt++; 
            else { if(board[r+dr*i]?.[c+dc*i] === 0) sides++; break; }
        }
        for (let i=1; i<5; i++) {
            if (board[r-dr*i]?.[c-dc*i] === p) cnt++; 
            else { if(board[r-dr*i]?.[c-dc*i] === 0) sides++; break; }
        }
        // æ ¹æ“š CONFIG æ±ºå®šæ˜¯å¦åµæ¸¬æ´»å£æ¬Šé‡
        if (cnt >= 4) w += 50000;
        else if (cnt === 3 && sides === 2) w += (CONFIG.hardVersion === 'reaper' ? 10000 : 5000);
        else if (cnt === 3 && sides === 1) w += 2000;
        else if (cnt === 2 && sides === 2) w += 1000;
    }
    return w;
}

function endGame(win) {
    isGameOver = true;
    if (win) {
        const limit = (difficulty === 'hard') ? 6 : 3;
        const myList = topScores[difficulty];
        const isTop = myList.length < limit || steps < myList[myList.length - 1].steps;
        if (isTop) {
            setTimeout(() => {
                const name = prompt(`ğŸ† ç ´ç´€éŒ„ï¼[${diffLabels[difficulty]}] åƒ…ç”¨ ${steps} æ­¥ï¼\nè«‹ç•™åï¼š`) || "é«˜æ‰‹";
                db.ref(paths[difficulty]).push({ name, steps, time: Date.now() });
            }, 600);
        } else alert(`å‹åˆ©ï¼ç”¨äº† ${steps} æ­¥ã€‚`);
    } else alert("NPC ç²å‹ï¼å»å–å£å²¡è¯é®®ä¹³æ·»æ™ºæ…§");
}

function animationLoop() {
    frameCount++;
    if (isGameOver) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        for(let i=0; i<15; i++) {
            ctx.fillStyle = i%2===0?'gold':'#FFF';
            ctx.beginPath();
            let x = (frameCount*5 + i*100)%canvas.width, y = (frameCount*3 + i*90)%canvas.height;
            ctx.arc(x, y, 3, 0, Math.PI*2); ctx.fill();
        }
    }
    requestAnimationFrame(animationLoop);
}
</script>
</body>
</html>
