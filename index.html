<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å²¡è¯äº”å­æ£‹ - ç‰§å ´å¤§å¸«è³½</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        :root { --coffee: #6f4e37; --wood: #e3c16f; --grass: #87CEEB; }
        body { margin: 0; background: var(--grass); font-family: "Microsoft JhengHei", sans-serif; display: flex; flex-direction: column; align-items: center; }
        
        /* å³ä¸Šè§’æ’è¡Œæ¦œ */
        #ui-leaderboard {
            position: absolute; top: 15px; right: 15px; background: rgba(0,0,0,0.4);
            color: white; padding: 10px; border-radius: 10px; font-size: 14px; z-index: 100;
            min-width: 150px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .rank-item { margin: 3px 0; display: block; }
        .gold { color: #FFD700; font-weight: bold; }

        /* éŠæˆ²é¸å–® */
        #setup-menu { margin-top: 100px; text-align: center; background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        h1 { color: var(--coffee); }
        
        /* æ£‹ç›¤å€åŸŸ */
        #game-area { display: none; text-align: center; margin-top: 50px; }
        #board { 
            display: grid; grid-template-columns: repeat(15, 25px); grid-template-rows: repeat(15, 25px); 
            background: var(--wood); border: 3px solid #8b4513; margin: 15px auto;
            box-shadow: 0 8px 16px rgba(0,0,0,0.3); cursor: pointer;
        }
        @media (min-width: 600px) { #board { grid-template-columns: repeat(15, 35px); grid-template-rows: repeat(15, 35px); } }
        
        .cell { border: 0.5px solid rgba(139, 69, 19, 0.3); display: flex; justify-content: center; align-items: center; position: relative; }
        .piece { width: 85%; height: 85%; border-radius: 50%; z-index: 5; animation: drop 0.2s ease-out; }
        .black { background: radial-gradient(circle at 30% 30%, #444, #000); box-shadow: 1px 1px 3px rgba(0,0,0,0.5); }
        .white { background: radial-gradient(circle at 30% 30%, #fff, #ccc); box-shadow: 1px 1px 3px rgba(0,0,0,0.3); }
        
        @keyframes drop { from { transform: scale(1.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .btn { background: var(--coffee); color: white; border: none; padding: 12px 25px; margin: 5px; border-radius: 50px; font-weight: bold; cursor: pointer; }
        .stats { font-size: 18px; color: #fff; text-shadow: 1px 1px 3px #000; margin-bottom: 10px; }
    </style>
</head>
<body>

<div id="ui-leaderboard">
    <b>ğŸ† å‰ä¸‰å (æœ€å°‘æ­¥æ•¸)</b>
    <div id="rank-content">è¼‰å…¥ä¸­...</div>
</div>

<div id="setup-menu">
    <h1>å²¡è¯äº”å­æ£‹</h1>
    <p>è«‹é¸æ“‡ NPC é›£åº¦</p>
    <button class="btn" onclick="startGomoku('easy')">åˆç´š</button>
    <button class="btn" onclick="startGomoku('medium')">ä¸­ç´š</button>
    <button class="btn" onclick="startGomoku('hard')">é«˜ç´š</button>
</div>

<div id="game-area">
    <div class="stats">é›£åº¦: <span id="display-lv">-</span> | æ­¥æ•¸: <span id="step-count">0</span></div>
    <div id="board"></div>
    <button class="btn" onclick="location.reload()">æ”¾æ£„ä¸¦è¿”å›</button>
</div>

<script>
// =========================================================================
// ğŸ”§ Firebase æ•´åˆ (æ²¿ç”¨æ‚¨çš„ API Key)
// =========================================================================
const firebaseConfig = {
  apiKey: "AIzaSyBQr_3o913vgaWUg4PAuequLEVE1mZFS7M",
  authDomain: "cowgame-48dd8.firebaseapp.com",
  databaseURL: "https://cowgame-48dd8-default-rtdb.firebaseio.com",
  projectId: "cowgame-48dd8",
  storageBucket: "cowgame-48dd8.firebasestorage.app",
  messagingSenderId: "957972615393",
  appId: "1:957972615393:web:14fd2ebb956a6c48ade7a0"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const rankRef = db.ref('gomoku_leaderboard'); // å»ºç«‹æ–°è·¯å¾‘ï¼Œé¿å…æ··æ·†

// =========================================================================
// ğŸ® éŠæˆ²é‚è¼¯
// =========================================================================
let board = [], steps = 0, isGameOver = false, difficulty = 'easy';

// å¯¦æ™‚æ›´æ–°æ’è¡Œæ¦œ (å°é½Šé›²ç«¯é‚è¼¯ï¼šæ­¥æ•¸å°‘è€…å„ªå…ˆ)
rankRef.orderByChild('steps').limitToFirst(3).on('value', (snapshot) => {
    const list = [];
    snapshot.forEach(child => { list.push(child.val()); });
    const container = document.getElementById('rank-content');
    container.innerHTML = list.map((item, i) => `
        <span class="rank-item ${i===0?'gold':''}">
            ${i+1}. ${item.name} : ${item.steps}æ­¥
        </span>
    `).join('') || "å°šç„¡ç´€éŒ„";
});

function startGomoku(lv) {
    difficulty = lv;
    document.getElementById('setup-menu').style.display = 'none';
    document.getElementById('game-area').style.display = 'block';
    document.getElementById('display-lv').innerText = lv.toUpperCase();
    initBoard();
}

function initBoard() {
    const boardEl = document.getElementById('board');
    boardEl.innerHTML = '';
    board = Array(15).fill().map(() => Array(15).fill(0));
    for (let r = 0; r < 15; r++) {
        for (let c = 0; c < 15; c++) {
            const cell = document.createElement('div');
            cell.className = 'cell';
            cell.onclick = () => playerMove(r, c);
            boardEl.appendChild(cell);
        }
    }
}

function playerMove(r, c) {
    if (board[r][c] !== 0 || isGameOver) return;
    placePiece(r, c, 1);
    steps++;
    document.getElementById('step-count').innerText = steps;

    if (checkWin(r, c, 1)) {
        isGameOver = true;
        setTimeout(() => handleWin(), 100);
        return;
    }
    setTimeout(npcMove, 500);
}

function npcMove() {
    if (isGameOver) return;
    let bestMove = findBestMove();
    placePiece(bestMove.r, bestMove.c, 2);
    if (checkWin(bestMove.r, bestMove.c, 2)) {
        isGameOver = true;
        setTimeout(() => alert("NPC ç²å‹ï¼è«‹å†æ¥å†å²ã€‚"), 100);
    }
}

function placePiece(r, c, p) {
    board[r][c] = p;
    const cellIndex = r * 15 + c;
    const cell = document.getElementsByClassName('cell')[cellIndex];
    const piece = document.createElement('div');
    piece.className = `piece ${p === 1 ? 'black' : 'white'}`;
    cell.appendChild(piece);
}

function checkWin(r, c, p) {
    const directions = [[1,0],[0,1],[1,1],[1,-1]];
    for (let [dr, dc] of directions) {
        let count = 1;
        for (let i=1; i<5; i++) if (board[r+dr*i]?.[c+dc*i] === p) count++; else break;
        for (let i=1; i<5; i++) if (board[r-dr*i]?.[c-dc*i] === p) count++; else break;
        if (count >= 5) return true;
    }
    return false;
}

// æ ¹æ“šé›£åº¦æ±ºå®š AI è½å­
function findBestMove() {
    if (difficulty === 'easy') {
        let r, c;
        do { r = Math.floor(Math.random()*15); c = Math.floor(Math.random()*15); } while (board[r][c] !== 0);
        return {r, c};
    }
    
    // ä¸­/é«˜ç´š AIï¼šæ¬Šé‡æƒæ
    let best = {r: 7, c: 7, score: -1};
    for(let r=0; r<15; r++) {
        for(let c=0; c<15; c++) {
            if (board[r][c] === 0) {
                let score = evalPos(r, c);
                if (score > best.score) { best = {r, c, score}; }
            }
        }
    }
    return best;
}

function evalPos(r, c) {
    let score = 0;
    const p1Score = getWeight(r, c, 1); // ç©å®¶å¨è„…
    const p2Score = getWeight(r, c, 2); // è‡ªå·±å„ªå‹¢
    // é«˜ç´šé›£åº¦æ›´å…·ä¾µç•¥æ€§
    return difficulty === 'hard' ? (p1Score * 1.5 + p2Score) : (p1Score + p2Score);
}

function getWeight(r, c, p) {
    let weight = 0;
    const directions = [[1,0],[0,1],[1,1],[1,-1]];
    for (let [dr, dc] of directions) {
        let count = 0;
        for (let i=1; i<5; i++) if (board[r+dr*i]?.[c+dc*i] === p) count++; else break;
        for (let i=1; i<5; i++) if (board[r-dr*i]?.[c-dc*i] === p) count++; else break;
        if (count >= 4) weight += 10000;
        else if (count === 3) weight += 1000;
        else if (count === 2) weight += 100;
    }
    return weight;
}

function handleWin() {
    const name = prompt(`ğŸ‰ å‹åˆ©ï¼ç¸½å…±èŠ±äº† ${steps} æ­¥ã€‚\nè«‹ç•™ä¸‹æ‚¨åœ¨å²¡è¯çš„å¤§åï¼š`) || "é«˜æ‰‹";
    rankRef.push({ name, steps, time: Date.now() });
    alert("æˆç¸¾å·²å°é½Šé›²ç«¯ï¼");
}
</script>
</body>
</html>
