<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°ˆæ¥­äº”å­æ£‹å°æˆ° - Proç‰ˆ</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-bundle.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-bundle.js"></script>
    <style>
        :root { --main-coffee: #6f4e37; --bg-cream: #f4f1ea; --wood: #e3c16f; }
        body { font-family: 'Segoe UI', Microsoft JhengHei, sans-serif; background: var(--bg-cream); margin: 0; display: flex; flex-direction: column; align-items: center; }
        
        /* æ’è¡Œæ¦œ */
        #leaderboard { position: fixed; right: 20px; top: 20px; background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 180px; z-index: 100; }
        #leaderboard h3 { margin-top: 0; font-size: 16px; color: var(--main-coffee); border-bottom: 2px solid var(--main-coffee); }
        #rank-list { padding-left: 20px; font-size: 14px; }

        /* é¸å–®èˆ‡æ¨™é¡Œ */
        .container { margin-top: 50px; text-align: center; }
        #menu { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        h1 { color: var(--main-coffee); margin-bottom: 30px; }
        
        /* æ£‹ç›¤ä½ˆå±€ */
        #game-info { display: none; }
        #board { 
            display: grid; grid-template-columns: repeat(15, 30px); grid-template-rows: repeat(15, 30px); 
            background: var(--wood); border: 4px solid #8b4513; border-radius: 4px; 
            margin: 20px auto; cursor: crosshair; box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        .cell { width: 30px; height: 30px; border: 0.5px solid rgba(139, 69, 19, 0.3); box-sizing: border-box; display: flex; justify-content: center; align-items: center; }
        
        /* æ£‹å­æ¨£å¼ */
        .piece { width: 26px; height: 26px; border-radius: 50%; animation: drop 0.2s ease-out; }
        .black { background: radial-gradient(circle at 30% 30%, #444, #000); box-shadow: 2px 2px 5px rgba(0,0,0,0.4); }
        .white { background: radial-gradient(circle at 30% 30%, #fff, #ccc); box-shadow: 2px 2px 5px rgba(0,0,0,0.2); }
        @keyframes drop { from { transform: scale(1.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* æŒ‰éˆ• */
        button { background: var(--main-coffee); color: white; border: none; padding: 12px 25px; margin: 10px; border-radius: 8px; font-weight: bold; transition: 0.3s; cursor: pointer; }
        button:hover { transform: translateY(-2px); background: #5a3e2b; }
        .stats { font-size: 18px; font-weight: bold; color: #555; }
    </style>
</head>
<body>

<div id="leaderboard">
    <h3>ğŸ† Top 3 (æœ€ç²¾ç°¡å‹)</h3>
    <ol id="rank-list"><li>ç­‰å¾…ä¸­...</li></ol>
</div>

<div class="container">
    <div id="menu">
        <h1>äº”å­æ£‹ NPC å°æˆ°</h1>
        <button onclick="bootGame('easy')">åˆç´š (ç·´ç¿’ç”¨)</button>
        <button onclick="bootGame('medium')">ä¸­ç´š (å…·é˜²å®ˆæ€§)</button>
        <button onclick="bootGame('hard')">é«˜ç´š (å°ˆæ¥­é€²æ”»)</button>
    </div>

    <div id="game-info">
        <div class="stats">é›£åº¦: <span id="cur-lv">-</span> | æ­¥æ•¸: <span id="step-count">0</span></div>
        <div id="board"></div>
        <button onclick="location.reload()" style="background:#999;">å›ä¸»é¸å–®</button>
    </div>
</div>

<script>
// --- [1] Firebase è¨­å®š (è«‹å‹™å¿…å¡«å…¥æ‚¨çš„ Key) ---
const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    databaseURL: "YOUR_DATABASE_URL",
    projectId: "YOUR_PROJECT_ID"
};

let db;
try {
    const app = firebase.initializeApp(firebaseConfig);
    db = firebase.database();
    updateLeaderboard();
} catch (e) { console.warn("Firebase æœªåˆå§‹åŒ–ï¼Œå°‡ä»¥é›¢ç·šæ¨¡å¼é‹è¡Œã€‚"); }

// --- [2] éŠæˆ²ç‹€æ…‹ ---
let board = [];
let steps = 0;
let difficulty = 'easy';
let isGameOver = false;

// --- [3] æ ¸å¿ƒåŠŸèƒ½ï¼šå•Ÿå‹•éŠæˆ² ---
function bootGame(lv) {
    console.log("æ­£åœ¨é€²å…¥éŠæˆ²ï¼Œç­‰ç´šï¼š" + lv);
    difficulty = lv;
    document.getElementById('menu').style.display = 'none';
    document.getElementById('game-info').style.display = 'block';
    document.getElementById('cur-lv').innerText = lv.toUpperCase();
    initBoard();
}

function initBoard() {
    const boardEl = document.getElementById('board');
    boardEl.innerHTML = '';
    board = Array(15).fill().map(() => Array(15).fill(0));
    for (let r = 0; r < 15; r++) {
        for (let c = 0; c < 15; c++) {
            const cell = document.createElement('div');
            cell.className = 'cell';
            cell.dataset.r = r; cell.dataset.c = c;
            cell.onclick = () => playerAction(r, c);
            boardEl.appendChild(cell);
        }
    }
}

function playerAction(r, c) {
    if (board[r][c] !== 0 || isGameOver) return;
    
    placePiece(r, c, 1);
    steps++;
    document.getElementById('step-count').innerText = steps;

    if (checkWin(r, c, 1)) {
        isGameOver = true;
        setTimeout(() => {
            alert(`ğŸ‰ æ‚¨è´äº†ï¼ç¸½å…±åªç”¨äº† ${steps} æ­¥ï¼`);
            saveResult(steps);
        }, 100);
        return;
    }
    
    setTimeout(npcAction, 400);
}

// --- [4] AI é‚è¼¯ï¼šæ¬Šé‡æƒææ¼”ç®—æ³• ---
function npcAction() {
    if (isGameOver) return;
    let best = { r: 7, c: 7, score: -1 };
    
    // éæ­·æ‰€æœ‰æ ¼å­ï¼Œè¨ˆç®—æ¬Šé‡
    for (let r = 0; r < 15; r++) {
        for (let c = 0; c < 15; c++) {
            if (board[r][c] === 0) {
                let score = evaluatePos(r, c);
                if (score > best.score) {
                    best = { r, c, score };
                }
            }
        }
    }
    
    placePiece(best.r, best.c, 2);
    if (checkWin(best.r, best.c, 2)) {
        isGameOver = true;
        setTimeout(() => alert("NPC ç²å‹ï¼å†æ¥å†å²ã€‚"), 100);
    }
}

function evaluatePos(r, c) {
    if (difficulty === 'easy') return Math.random();
    
    // ç°¡å–®æ¬Šé‡è¡¨ (é«˜ç´šé›£åº¦æœƒæ›´é‡è¦–é€£ 3 èˆ‡é€£ 4)
    let attackScore = getScore(r, c, 2); // è‡ªå·±çš„é€²æ”»
    let defenseScore = getScore(r, c, 1); // æ“‹ä½ç©å®¶
    
    if (difficulty === 'medium') return attackScore + defenseScore * 0.8;
    return attackScore + defenseScore * 1.5; // é«˜ç´šæ›´çœ‹é‡é˜²å®ˆ
}

function getScore(r, c, p) {
    let score = 0;
    const directions = [[1,0],[0,1],[1,1],[1,-1]];
    for (let [dr, dc] of directions) {
        let count = 1;
        // æ¨¡æ“¬è½å­å¾Œèƒ½é€£æˆå¹¾å€‹
        for (let i=1; i<5; i++) if (board[r+dr*i]?.[c+dc*i] === p) count++; else break;
        for (let i=1; i<5; i++) if (board[r-dr*i]?.[c-dc*i] === p) count++; else break;
        
        // æ¬Šé‡è¨ˆç®—
        if (count >= 5) score += 100000;
        else if (count === 4) score += 5000;
        else if (count === 3) score += 500;
        else if (count === 2) score += 50;
    }
    return score;
}

// --- [5] é€šç”¨é‚è¼¯ ---
function placePiece(r, c, p) {
    board[r][c] = p;
    const cell = document.querySelector(`.cell[data-r="${r}"][data-c="${c}"]`);
    const div = document.createElement('div');
    div.className = `piece ${p === 1 ? 'black' : 'white'}`;
    cell.appendChild(div);
}

function checkWin(r, c, p) {
    const directions = [[1,0],[0,1],[1,1],[1,-1]];
    for (let [dr, dc] of directions) {
        let count = 1;
        for (let i=1; i<5; i++) if (board[r+dr*i]?.[c+dc*i] === p) count++; else break;
        for (let i=1; i<5; i++) if (board[r-dr*i]?.[c-dc*i] === p) count++; else break;
        if (count >= 5) return true;
    }
    return false;
}

function saveResult(s) {
    const name = prompt("æ¦®ç™»æ¦œå–®ï¼è«‹ç•™ä¸‹æ‚¨çš„ç¨±å‘¼:") || "ç„¡åå¤§å¸«";
    if (db) {
        db.ref('gomoku_ranking').push({ name, steps: s, time: Date.now() });
    }
}

function updateLeaderboard() {
    if (!db) return;
    db.ref('gomoku_ranking').orderByChild('steps').limitToFirst(3).on('value', (snap) => {
        const list = document.getElementById('rank-list');
        list.innerHTML = '';
        snap.forEach(child => {
            const data = child.val();
            list.innerHTML += `<li>${data.name} (${data.steps}æ­¥)</li>`;
        });
    });
}
</script>
</body>
</html>
