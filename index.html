<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å²¡è¯äº”å­æ£‹ - å¤§å¸«è³½æ——è‰¦ç‰ˆ</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        :root { --coffee: #6f4e37; --wood: #e3c16f; --grass: #87CEEB; --gold: #FFD700; }
        body { margin: 0; background: var(--grass); font-family: "Microsoft JhengHei", sans-serif; overflow: hidden; display: flex; flex-direction: column; align-items: center; touch-action: none; }
        
        /* å³ä¸Šè§’æ’è¡Œæ¦œ */
        #ui-leaderboard {
            position: absolute; top: 15px; right: 15px; background: rgba(0,0,0,0.6);
            color: white; padding: 12px; border-radius: 12px; font-size: 13px; z-index: 110;
            min-width: 170px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); border: 1px solid var(--gold);
        }
        .rank-item { margin: 5px 0; display: block; border-bottom: 0.5px solid rgba(255,255,255,0.2); padding-bottom: 2px; }
        .rank-item small { color: #ccc; margin-left: 4px; }
        .gold { color: var(--gold); font-weight: bold; }

        /* éŠæˆ²é¸å–® */
        #setup-menu { margin-top: 100px; text-align: center; background: white; padding: 40px; border-radius: 25px; box-shadow: 0 15px 40px rgba(0,0,0,0.2); z-index: 120; width: 80%; max-width: 320px; }
        
        /* æ£‹ç›¤å®¹å™¨ */
        #game-container { position: relative; margin-top: 60px; z-index: 10; display: none; text-align: center; }
        canvas#victoryCanvas { position: absolute; top: 0; left: 0; pointer-events: none; z-index: 100; }
        
        #board { 
            display: grid; grid-template-columns: repeat(15, 22px); grid-template-rows: repeat(15, 22px); 
            background: var(--wood); border: 5px solid #8b4513; border-radius: 5px; cursor: pointer;
            box-shadow: 0 10px 30px rgba(0,0,0,0.4); margin: 0 auto;
        }
        @media (min-width: 600px) { #board { grid-template-columns: repeat(15, 38px); grid-template-rows: repeat(15, 38px); } }
        
        /* æ£‹å­æ¨£å¼ */
        .cell { border: 0.5px solid rgba(139, 69, 19, 0.4); display: flex; justify-content: center; align-items: center; }
        .piece { width: 90%; height: 90%; border-radius: 50%; animation: drop 0.25s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .black { background: radial-gradient(circle at 35% 35%, #555, #000); box-shadow: 2px 2px 5px rgba(0,0,0,0.6); }
        .white { background: radial-gradient(circle at 35% 35%, #fff, #bbb); box-shadow: 2px 2px 5px rgba(0,0,0,0.3); }
        
        @keyframes drop { from { transform: translateY(-20px) scale(1.2); opacity: 0; } to { transform: translateY(0) scale(1); opacity: 1; } }

        /* æŒ‰éˆ•æ¨£å¼ */
        .btn { background: var(--coffee); color: white; border: none; padding: 12px 30px; margin: 8px; border-radius: 50px; font-weight: bold; cursor: pointer; font-size: 18px; box-shadow: 0 4px 0 #4e3626; width: 100%; box-sizing: border-box; }
        .btn:active { transform: translateY(2px); box-shadow: 0 2px 0 #4e3626; }
        .stats { font-size: 18px; color: white; text-shadow: 2px 2px 4px #000; margin-bottom: 12px; font-weight: bold; }
    </style>
</head>
<body>

<div id="ui-leaderboard">
    <b style="color:var(--gold)">ğŸ† å²¡è¯å¤§å¸«æ¦œ (å°‘æ­¥å‹)</b>
    <div id="rank-content" style="margin-top:8px">è®€å–é›²ç«¯ä¸­...</div>
</div>

<div id="setup-menu">
    <h1 style="color:var(--coffee); margin-top:0; font-size: 26px;">å²¡è¯äº”å­æ£‹</h1>
    <p style="color:#666; margin-bottom:20px;">è«‹é¸æ“‡å°æ‰‹é›£åº¦</p>
    <button class="btn" onclick="startGomoku('easy')">åˆç´š</button>
    <button class="btn" onclick="startGomoku('medium')">ä¸­ç´š</button>
    <button class="btn" onclick="startGomoku('hard')" style="background:#d32f2f; box-shadow:0 4px 0 #8e2020">å¤§å¸«ç´š NPC</button>
</div>

<div id="game-container">
    <div class="stats">é›£åº¦: <span id="display-lv">-</span> | æ­¥æ•¸: <span id="step-count">0</span></div>
    <div id="board"></div>
    <canvas id="victoryCanvas"></canvas>
    <button class="btn" onclick="location.reload()" style="background:#666; box-shadow:0 4px 0 #444; margin-top:25px; width:150px;">å›é¸å–®</button>
</div>

<script>
// =========================================================================
// ğŸ”§ Firebase æ•´åˆå€ (å·²å°é½Šæ‚¨çš„æŠ“ç‰›ç¨‹å¼è³‡æ–™åº«)
// =========================================================================
const firebaseConfig = {
  apiKey: "AIzaSyBQr_3o913vgaWUg4PAuequLEVE1mZFS7M",
  authDomain: "cowgame-48dd8.firebaseapp.com",
  databaseURL: "https://cowgame-48dd8-default-rtdb.firebaseio.com",
  projectId: "cowgame-48dd8"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const rankRef = db.ref('gomoku_master_ranking');

// é›£åº¦æ¨™ç±¤å°æ‡‰è¡¨
const diffLabels = { 'easy': 'åˆç´š', 'medium': 'ä¸­ç´š', 'hard': 'å¤§å¸«ç´š' };

// =========================================================================
// ğŸ® éŠæˆ²ç‹€æ…‹è®Šæ•¸
// =========================================================================
let board = [], steps = 0, isGameOver = false, difficulty = 'easy', frameCount = 0;
const canvas = document.getElementById('victoryCanvas');
const ctx = canvas.getContext('2d');

// å¯¦æ™‚è®€å–æ’è¡Œæ¦œ (æ•´åˆæ‹¬è™Ÿé¡¯ç¤ºåŠŸèƒ½)
rankRef.orderByChild('steps').limitToFirst(3).on('value', snap => {
    const list = [];
    snap.forEach(c => list.push(c.val()));
    document.getElementById('rank-content').innerHTML = list.map((item, i) => {
        const dTag = item.difficulty ? `(${item.difficulty})` : "";
        return `
            <span class="rank-item ${i===0?'gold':''}">
                ${i+1}. ${item.name}<small>${dTag}</small> : <b>${item.steps}</b> æ­¥
            </span>
        `;
    }).join('') || "ç­‰å¾…é¦–ä½å¤§å¸«...";
});

// =========================================================================
// ğŸš€ æ ¸å¿ƒå‡½å¼
// =========================================================================
function startGomoku(lv) {
    difficulty = lv;
    document.getElementById('setup-menu').style.display = 'none';
    document.getElementById('game-container').style.display = 'block';
    document.getElementById('display-lv').innerText = diffLabels[lv];
    
    // åˆå§‹åŒ–æ£‹ç›¤èˆ‡ç•«å¸ƒ
    const b = document.getElementById('board');
    canvas.width = b.offsetWidth; canvas.height = b.offsetHeight;
    initBoard();
    requestAnimationFrame(animationLoop);
}

function initBoard() {
    const boardEl = document.getElementById('board');
    boardEl.innerHTML = '';
    board = Array(15).fill().map(() => Array(15).fill(0));
    for (let r = 0; r < 15; r++) {
        for (let c = 0; c < 15; c++) {
            const cell = document.createElement('div');
            cell.className = 'cell';
            cell.onclick = () => playerMove(r, c);
            boardEl.appendChild(cell);
        }
    }
}

function playerMove(r, c) {
    if (board[r][c] !== 0 || isGameOver) return;
    placePiece(r, c, 1);
    steps++;
    document.getElementById('step-count').innerText = steps;
    if (checkWin(r, c, 1)) { endGame(true); return; }
    setTimeout(npcMove, 400);
}

function npcMove() {
    if (isGameOver) return;
    let best = findBestMove();
    placePiece(best.r, best.c, 2);
    if (checkWin(best.r, best.c, 2)) { endGame(false); }
}

function placePiece(r, c, p) {
    board[r][c] = p;
    const cell = document.getElementsByClassName('cell')[r * 15 + c];
    const div = document.createElement('div');
    div.className = `piece ${p === 1 ? 'black' : 'white'}`;
    cell.appendChild(div);
}

function checkWin(r, c, p) {
    const dirs = [[1,0],[0,1],[1,1],[1,-1]];
    for (let [dr, dc] of dirs) {
        let cnt = 1;
        for (let i=1; i<5; i++) if (board[r+dr*i]?.[c+dc*i] === p) cnt++; else break;
        for (let i=1; i<5; i++) if (board[r-dr*i]?.[c-dc*i] === p) cnt++; else break;
        if (cnt >= 5) return true;
    }
    return false;
}

// =========================================================================
// ğŸ§  å¤§å¸«ç´šæ¬Šé‡ AI
// =========================================================================
function findBestMove() {
    let best = {r: 7, c: 7, score: -1};
    for(let r=0; r<15; r++) {
        for(let c=0; c<15; c++) {
            if (board[r][c] === 0) {
                let score = evalPos(r, c);
                if (score > best.score) best = {r, c, score};
            }
        }
    }
    return best;
}

function evalPos(r, c) {
    if (difficulty === 'easy') return Math.random();
    let p1 = getW(r, c, 1), p2 = getW(r, c, 2);
    // å¤§å¸«ç´šé‡é»ï¼šç˜‹ç‹‚é˜²ç¦¦ç©å®¶çš„é€£ç·š
    return difficulty === 'hard' ? (p1 * 1.8 + p2) : (p1 + p2);
}

function getW(r, c, p) {
    let w = 0;
    const dirs = [[1,0],[0,1],[1,1],[1,-1]];
    for (let [dr, dc] of dirs) {
        let cnt = 0, sides = 0;
        for (let i=1; i<5; i++) {
            if (board[r+dr*i]?.[c+dc*i] === p) cnt++; 
            else { if(board[r+dr*i]?.[c+dc*i] === 0) sides++; break; }
        }
        for (let i=1; i<5; i++) {
            if (board[r-dr*i]?.[c-dc*i] === p) cnt++; 
            else { if(board[r-dr*i]?.[c-dc*i] === 0) sides++; break; }
        }
        if (cnt >= 4) w += 10000;
        else if (cnt === 3 && sides === 2) w += 5000; // æ´»å››
        else if (cnt === 3) w += 800;
        else if (cnt === 2 && sides === 2) w += 400;
    }
    return w;
}

// =========================================================================
// âœ¨ ç‰¹æ•ˆèˆ‡çµç®—
// =========================================================================
function endGame(isPlayerWin) {
    isGameOver = true;
    if (isPlayerWin) {
        setTimeout(() => {
            const name = prompt(`ğŸ† å‹åˆ©ï¼ç¸½è€—è²» ${steps} æ­¥ã€‚\nè«‹ç•™ä¸‹æ‚¨çš„å¤§åï¼š`) || "é«˜æ‰‹";
            rankRef.push({ 
                name: name, 
                steps: steps, 
                difficulty: diffLabels[difficulty], 
                time: Date.now() 
            });
        }, 500);
    } else {
        alert("NPC ç²å‹ï¼å†æ¥å†å²ã€‚");
    }
}

function animationLoop() {
    frameCount++;
    if (isGameOver) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        for(let i=0; i<15; i++) {
            ctx.fillStyle = ['#FFD700', '#FFF', '#FFA500'][i%3];
            ctx.beginPath();
            let x = (frameCount*5 + i*80) % canvas.width;
            let y = (frameCount*3 + i*60) % canvas.height;
            ctx.arc(x, y, 4, 0, Math.PI*2);
            ctx.fill();
        }
    }
    requestAnimationFrame(animationLoop);
}
</script>
</body>
</html>
